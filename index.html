<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Traffic Prediction Map</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- LeafletJS CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Custom styles for the map and overall layout */
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Prevent scrolling of the whole page */
        }
        #map {
            height: 100vh;
            width: 100%;
            z-index: 10;
        }
        .leaflet-control-zoom {
            border-radius: 8px !important;
        }
        /* Custom pulse animation for the location marker */
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.5;
            }
            70% {
                transform: scale(2.5);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 0;
            }
        }
        .pulse-ring {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: #3b82f6;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
            z-index: -1;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .location-marker {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="map"></div>

    <!-- UI Overlay Panel -->
    <div class="absolute top-0 left-0 right-0 z-20 p-2 sm:p-4 pointer-events-none">
        <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            
            <!-- Left Side: Title and Time -->
            <div class="bg-white/80 backdrop-blur-sm p-4 rounded-xl shadow-lg pointer-events-auto w-full sm:w-auto">
                <h1 class="text-xl sm:text-2xl font-bold text-gray-800">Traffic Prediction Map</h1>
                <p class="text-sm text-gray-500 flex items-center mt-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-geo-alt-fill mr-1.5" viewBox="0 0 16 16">
                      <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
                    </svg>
                    Coimbatore, Tamil Nadu
                </p>
                <p id="currentTime" class="text-sm font-medium text-blue-600 mt-1"></p>
            </div>

            <!-- Right Side: Controls and Legend -->
            <div class="flex flex-col gap-3 pointer-events-auto w-full sm:w-auto">
                <!-- Time Period Selection -->
                <div class="bg-white/80 backdrop-blur-sm p-3 rounded-xl shadow-lg">
                    <p class="text-sm font-semibold text-gray-700 mb-2 text-center">Select Time of Day</p>
                    <div id="time-controls" class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <button data-time="morning" class="time-btn bg-white hover:bg-blue-500 hover:text-white text-gray-700 font-semibold py-2 px-4 rounded-lg shadow transition-colors duration-200">Morning</button>
                        <button data-time="midday" class="time-btn bg-white hover:bg-blue-500 hover:text-white text-gray-700 font-semibold py-2 px-4 rounded-lg shadow transition-colors duration-200">Mid-day</button>
                        <button data-time="evening" class="time-btn bg-white hover:bg-blue-500 hover:text-white text-gray-700 font-semibold py-2 px-4 rounded-lg shadow transition-colors duration-200">Evening</button>
                        <button data-time="night" class="time-btn bg-white hover:bg-blue-500 hover:text-white text-gray-700 font-semibold py-2 px-4 rounded-lg shadow transition-colors duration-200">Night</button>
                    </div>
                </div>

                <!-- Legend -->
                <div class="bg-white/80 backdrop-blur-sm p-3 rounded-xl shadow-lg">
                     <p class="text-sm font-semibold text-gray-700 mb-2 text-center">Traffic Legend</p>
                    <div class="flex justify-around items-center gap-4 px-2">
                        <div class="flex items-center">
                            <span class="w-3 h-3 rounded-full bg-green-500 mr-2"></span>
                            <span class="text-xs font-medium text-gray-600">Light</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-3 h-3 rounded-full bg-orange-500 mr-2"></span>
                            <span class="text-xs font-medium text-gray-600">Moderate</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-3 h-3 rounded-full bg-red-600 mr-2"></span>
                            <span class="text-xs font-medium text-gray-600">Heavy</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- 1. INITIALIZE MAP ---
            const coimbatoreCoords = [11.0168, 76.9558];
            const map = L.map('map', {
                zoomControl: false // Disable default zoom control
            }).setView(coimbatoreCoords, 13);
            
            L.control.zoom({
                position: 'bottomright' // Move zoom control
            }).addTo(map);

            // Add tile layer - using OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            // --- Custom Location Marker ---
            const locationIcon = L.divIcon({
                className: 'location-marker',
                html: '<div class="w-5 h-5 bg-blue-500 rounded-full border-2 border-white shadow-md"></div><div class="pulse-ring"></div>',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });

            L.marker(coimbatoreCoords, { icon: locationIcon }).addTo(map)
                .bindPopup("<b>Your Location</b><br>Coimbatore, Tamil Nadu")
                .openPopup();

            // --- 2. DEFINE ROUTES & TRAFFIC DATA ---
            const trafficLayerGroup = L.layerGroup().addTo(map);

            // Coordinates for major roads in Coimbatore
            const routes = {
                'Avinashi Road': [
                    [11.0183, 76.9796], [11.0205, 77.0012], [11.0238, 77.0253], [11.0298, 77.0495], [11.033, 77.061]
                ],
                'Mettupalayam Road': [
                    [11.0250, 76.9630], [11.0394, 76.9582], [11.0581, 76.9501], [11.0768, 76.9423]
                ],
                'Trichy Road': [
                    [11.0065, 76.9839], [10.9995, 77.0084], [10.9932, 77.0345], [10.9856, 77.051]
                ],
                'Sathy Road': [
                    [11.020, 76.974], [11.035, 76.987], [11.051, 76.999], [11.065, 77.012]
                ],
                'Cross-City Connector': [
                    [11.0394, 76.9582], [11.018, 76.965], [11.0065, 76.9839]
                ]
            };
            
            // Traffic simulation logic based on time of day
            const trafficConditions = {
                morning: { default: 'heavy', exceptions: { 'Sathy Road': 'moderate' } },
                midday: { default: 'light', exceptions: { 'Avinashi Road': 'moderate' } },
                evening: { default: 'heavy', exceptions: { 'Mettupalayam Road': 'moderate' } },
                night: { default: 'light', exceptions: {} }
            };

            const trafficColors = {
                light: '#22c55e', // green-500
                moderate: '#f97316', // orange-500
                heavy: '#dc2626' // red-600
            };

            // --- 3. DRAW TRAFFIC ON MAP ---
            function simulateAndDrawTraffic(timeOfDay) {
                trafficLayerGroup.clearLayers(); // Clear previous routes

                const condition = trafficConditions[timeOfDay];
                if (!condition) return;
                
                // Animate button selection
                document.querySelectorAll('.time-btn').forEach(btn => {
                    if(btn.dataset.time === timeOfDay) {
                        btn.classList.add('bg-blue-500', 'text-white');
                        btn.classList.remove('bg-white', 'text-gray-700');
                    } else {
                        btn.classList.remove('bg-blue-500', 'text-white');
                        btn.classList.add('bg-white', 'text-gray-700');
                    }
                });

                for (const roadName in routes) {
                    const level = condition.exceptions[roadName] || condition.default;
                    const color = trafficColors[level];
                    
                    const polyline = L.polyline(routes[roadName], {
                        color: color,
                        weight: 6,
                        opacity: 0.8,
                        smoothFactor: 1
                    });
                    
                    polyline.bindTooltip(`${roadName}<br><b>${level.charAt(0).toUpperCase() + level.slice(1)} Traffic</b>`, {
                        sticky: true,
                        className: 'font-sans rounded-md'
                    });

                    polyline.addTo(trafficLayerGroup);
                }
            }

            // --- 4. EVENT HANDLERS & INITIALIZATION ---
            
            // Time controls
            document.getElementById('time-controls').addEventListener('click', (e) => {
                if (e.target.classList.contains('time-btn')) {
                    const time = e.target.dataset.time;
                    simulateAndDrawTraffic(time);
                }
            });

            // Update clock
            const currentTimeEl = document.getElementById('currentTime');
            function updateClock() {
                // Using the provided fixed date as a base, but making the time dynamic
                const now = new Date();
                const fixedDate = new Date('2025-09-21T00:00:00');
                fixedDate.setHours(now.getHours(), now.getMinutes(), now.getSeconds());

                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: '2-digit', second: '2-digit', timeZoneName: 'short' };
                currentTimeEl.textContent = fixedDate.toLocaleDateString('en-US', options);
                
                // Determine current time period for initial load
                 const currentHour = now.getHours();
                 let initialTime;
                 if (currentHour >= 6 && currentHour < 10) { // 6am - 10am
                     initialTime = 'morning';
                 } else if (currentHour >= 10 && currentHour < 16) { // 10am - 4pm
                     initialTime = 'midday';
                 } else if (currentHour >= 16 && currentHour < 21) { // 4pm - 9pm
                     initialTime = 'evening';
                 } else { // 9pm - 6am
                     initialTime = 'night';
                 }
                 return initialTime;
            }
            
            // Initial call
            const initialTimePeriod = updateClock();
            simulateAndDrawTraffic(initialTimePeriod);
            setInterval(updateClock, 1000);
        });
    </script>
</body>
</html>
